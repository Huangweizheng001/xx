<!DOCTYPE html>
<html lang="en">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
    <meta name="renderer" content="webkit">
    <!--<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">-->
    <meta name="format-detection" content="telephone=yes">
    <meta name="Keywords" content="亿策数字校园">
    <meta name="description" content="亿策数字校园" />
    <title>老师个人中心-上传课程</title>
    <link rel="stylesheet" href="./librarycss/base.css" />
    <link rel="stylesheet" href="./librarycss/swiper,animate,scroll.min.css" />

</head>
<body style="background: #fff;">

<section>
    <div class="uploadCourse">
        <div class="title"><span>上传课程</span><a href="teachercentercourse.html">返回</a></div>
        <div class="firstStep" v-show="isShow" id="uploadCourse">
            <div class="feaddcourseview-title">
                <span><b></b>第一步</span> 设置课程基本信息
            </div>
            <ul class="content">
                <li class="li-style">
                    <b class="caption">课程封面:</b>
                    <form action="" id="addImg">
                        <div class="addImage">
                            <img src="../../images/temp/teachercenter-add.jpg" alt="">
                            <input type="file" name="iconPath" @change="addCover($event)">
                        </div>
                    </form>
                    <i class="tip">图片大小不超过5M</i>
                </li>
                <li class="li-style">
                    <b class="caption">课程名称:</b>
                    <input type="text" class="inputText" name="name" v-model="coursename" id="coursename">
                </li>
                <li style="padding-left: 0" class="li-style">
                    <div class="selectBox" style="margin-left: 0">
                        <span>年&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;级:</span>
                        <select name="gradeId" id="grade" v-cloak v-model="gradeId">
                            <option v-for="item in gradeArr" :value="item.gradeId" >{{item.name}}</option>
                        </select>
                    </div>
                    <div class="selectBox">
                        <span>学&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;期:</span>
                        <select name="termId" id="term" v-cloak v-model="termId">
                            <option :value="item.id" v-for="item in termArr" >{{item.name}}</option>
                        </select>
                    </div>
                    <div class="selectBox">
                        <span>学&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;科:</span>
                        <select name="subjectId" id="subject" v-cloak v-model="subjectId">
                            <option :value="item.subjectId" v-for="item in subjectArr" >{{item.name}}</option>
                        </select>
                    </div>
                </li>
                <li class="li-style">
                    <b class="caption">目&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;录:</b>
                    <div class="catalog">
                        <div class="nodata" v-show="nodata" v-cloak>暂无目录 o(╥﹏╥)o</div>
                        <div class="first" v-cloak v-for="list in outlineArr">
                            <!--caret-right-->
                            <!--caret-down-->
                            <i class="uk-icon-caret-down" v-if="list.childNodes.length>0"></i>
                            <h4 v-bind:data-id="list.nodeId">{{list.nodeName}}</h4>
                            <ul class="second">
                                <li v-for="item in list.childNodes">
                                    <i class="uk-icon-caret-down" v-if="item.childNodes.length>0"></i>
                                    <h4 v-bind:data-id="item.nodeId">{{item.nodeName}}</h4>
                                    <ul class="three">
                                        <li v-for="i in item.childNodes">
                                            <h4 v-bind:data-id="i.nodeId">{{i.nodeName}}</h4>
                                        </li>
                                    </ul>
                                </li>
                            </ul>
                        </div>
                        <!--<div class="first">-->
                        <!--&lt;!&ndash;caret-right&ndash;&gt;-->
                        <!--&lt;!&ndash;caret-down&ndash;&gt;-->
                        <!--<i class="uk-icon-caret-down"></i>-->
                        <!--<h4>第二单元 成长体验</h4>-->
                        <!--<ul class="second">-->
                        <!--<li>-->
                        <!--<i class="uk-icon-caret-down"></i>-->
                        <!--<h4>1、从百草园到三味书屋</h4>-->
                        <!--<ul class="three">-->
                        <!--<li>-->
                        <!--<h4>测试章节</h4>-->
                        <!--</li>-->
                        <!--</ul>-->
                        <!--</li>-->
                        <!--</ul>-->
                        <!--</div>-->
                    </div>
                    <p>已选中目录为: <span v-cloak>{{syllabusName}}</span></p>
                </li>
            </ul>
            <div class="operation">
                <button @click="saveFirstStep()">保存基本信息</button>
            </div>
        </div>
        <div class="secondStep" style="display: none">
            <div class="feaddcourseview-title">
                <span><b></b>第二步</span> 上传视频
            </div>
            <div class="content">
                <div class="videoform" id="tab_1">
                    <input type="hidden" id="uploadAuth" name="uploadAuth" />
                    <input type="hidden" id="uploadAddress" name="uploadAddress" />
                    <input type="hidden" id="accessKeyId" name="accessKeyId" value="LTAIm2NCAnY8W7u9" />
                    <input type="hidden" id="accessKeySecret" name="accessKeySecret" value="fzn9oa6DnqfRb6RFMSZxQzaxxEC3GU" />
                    <!--<input type="hidden" id="accessKeyId" name="accessKeyId" value="LTAIBin89mSGMcZ2" />
                    <input type="hidden" id="accessKeySecret" name="accessKeySecret" value="jCRSeLiMcyWWZnsNwhahKfOWdO4hJG" />-->
                    <input type="hidden" id="secretToken" name="secretToken" />
                    <input type="hidden" id="expireTime" name="expireTime" />
                    <input type="hidden" id="endpoint" name="endpoint" value="http://oss-cn-shanghai.aliyuncs.com" />
                    <input type="hidden" id="bucket" name="bucket" value="ycjdJYJ" />
                    <input type="hidden" id="objectPre" name="objectPre" value="upload" />
                    <input type="hidden" id="coverurl" name="coverurl" value="" />
                    <!--<input type="hidden" id="fromUrl" name="fromUrl" value="" />-->

                    <!--<input type="hidden" id="allowListen" name="allowListen" value="0"/>-->
                    <!--<input type="hidden" id="auditState" name="auditState" value="0"/>-->
                    <!--<input type="hidden" id="auditTime" name="auditTime" value=""/>-->
                    <!--<input type="hidden" id="auditorId" name="auditorId" value="0"/>-->
                    <!--<input type="hidden" id="recommendListen" name="recommendListen" value="0"/>-->

                    <input type="hidden" id="videoId" name="videoId" />
                    <input type="hidden" id="tag" name="tag" />
                    <input type="hidden" id="courseVideoId" name="courseVideoId" />
                    <input type="hidden" id="courseId" name="courseId" />
                    <!--<input type="hidden" id="code" name="code" />-->
                    <!--<input type="hidden" id="courseTypeId" name="courseTypeId" />-->

                    <div class="" id="alreadVideo">

                    </div>

                    <div class="control-group">
                        <label class="control-label">视频描述</label>
                        <div class="controls">
                            <!--<input class="span6 m-wrap" type="text" disabled id="description" name="description" />-->
                            <input class="" type="text" id="description" name="description" />
                        </div>
                    </div>

                    <div class="control-group">
                        <label class="control-label">视频标签:</label>
                        <div class="controls">
                            <input class="" type="text" id="tags" name="tags" value="" />
                        </div>
                    </div>
                    <div class="control-group">
                        <label class="control-label">视频文件</label>
                        <div class="controls">
                            <input type="file" name="files" id="files" accept="video/*" multiple />
                        </div>
                    </div>
                    <!--<div class="control-group">-->
                    <!--<label class="control-label"></label>-->
                    <!--<div class="controls">-->
                    <!--<input type="text" id="deleteIndex" size="3" placeholder="请输入您要删除第几个文件" value="" />
                    <button type="button" class="btn" onclick="deleteFile()">删除文件</button>
                    <button type="button" class="btn" onclick="getList()">获取上传列表</button>
                    <button type="button" class="btn" onclick="clearList()">清除上传列表</button>-->
                    <!--</div>-->
                    <!--</div>-->
                    <div id="Progress_Bars">
                    </div>
                    <div class="control-group" style="display: none">
                        <label class="control-label">日志</label>
                        <div class="controls">
                            <select multiple="multiple" id="textarea" style="position: relative; word-wrap: break-word; width: 690px; height: 250px; vertical-align: top; border: 1px solid #cccccc;"></select>
                        </div>
                    </div>

                </div>

                <div class="formbtn">
                    <button type="button" class="btn blue" onclick="start()">开始上传</button>
                    <button type="button" class="btn red" onclick="stop()">停止上传</button>
                    <button type="button" class="btn yellow" onclick="clearList()">清除上传列表</button>
                    <button type="button" class="btn green" onclick="resumeWithToken()">Token恢复上传</button>
                    <!--   <button type="button" class="btn" onclick="clearLog()">清日志</button>-->
                </div>
            </div>
        </div>
    </div>

</section>




<script type="text/javascript" src="./libraryjs/jquery.min.js"></script>
<script type="text/javascript" src="./libraryjs/jquery.storage.js"></script>
<script type="text/javascript" src="./libraryjs/swiper.min.js"></script>
<script type="text/javascript" src="./libraryjs/layer,wow,scroll.js"></script>
<script type="text/javascript" src="./libraryjs/vue.min.js"></script>
<script type="text/javascript" src="./libraryjs/vue-resource.min.js"></script>
<script type="text/javascript" src="./libraryjs/config.js"></script>
<script type="text/javascript" src="./libraryjs/aliyun-sdk.min.js"></script>
<script type="text/javascript" src="./libraryjs/vod-sdk-upload-1.0.6.min.js"></script>
<script type="text/javascript">
    var uploader;
    var fileIndex = 0;
    var ProgressIndex = 0;
    // var accessKeyId = document.getElementById("accessKeyId").value;
    // var accessKeySecret = document.getElementById("accessKeySecret").value;
    // var secretToken = document.getElementById("secretToken").value;
    window.onload = new function () {
        var tagVal = $(this).getUrlParam("tag");
        if(tagVal == ''|| tagVal == undefined || tagVal == 'undefined'){
            tagVal = 'add';
        }
        $('#tag').val(tagVal);
        if(tagVal == 'update'){
            $.ajax({
                //async: false,
                type: "post",
                url: SERVERROOTDATA + "api/teacher/site/course.ashx?action=showCourseVideoById",
                data: {
                    ycToken:$(window).storager({key: 'ycToken'}).readStorage(),
                    id: $(this).getUrlParam("courseId")
                }, //提交表单，vistor.ashx?ID=XXX
                success: function (res) {
                    var data = JSON.parse(res);
                    if(data.code==200){
                        if(data.rows.length>0){
                            // $('#allowListen').val(data.rows[0].allowListen);
                            // $('#auditState').val(data.rows[0].auditState);
                            // $('#auditTime').val(data.rows[0].auditTime);
                            // $('#auditorId').val(data.rows[0].auditorId);
                            // $('#recommendListen').val(data.rows[0].recommendListen);
                            var html=$('<div class="alreadVideo"><span>已上传视频:</span><a >'+ data.rows[0].videoPath +'</a></div>');
                            $('#alreadVideo').append(html);
                        }
                    }
                } //操作成功后的操作！msg是后台传过来的值
                , error: function (ex) {
                    alert("error");
                }
            });
        }
        var h = $('.uploadCourse').height();
        $(window.parent.document).find("#jTeacherIframe").css("height", h + 280 +"px");

        uploader = new VODUpload({
            // 文件上传失败
            'onUploadFailed': function (uploadInfo, code, message) {
                log("onUploadFailed: file:" + uploadInfo.file.name + ",code:" + code + ", message:" + message);
            },
            // 文件上传完成
            'onUploadSucceed': function (uploadInfo) {
                ProgressIndex++;
                save(uploadInfo.file.name);
                log("onUploadSucceed: " + uploadInfo.file.name + ", endpoint:" + uploadInfo.endpoint + ", bucket:" + uploadInfo.bucket + ", object:" + uploadInfo.object);
            },
            // 文件上传进度
            'onUploadProgress': function (uploadInfo, totalSize, uploadedSize) {
                Progress_Bar((uploadedSize * 100 / totalSize).toFixed(2), 'bar' + ProgressIndex, 'processbar' + ProgressIndex);

                // console.log("onUploadProgress:file:" + uploadInfo.file.name + ", fileSize:" + totalSize + ", percent:" + (uploadedSize * 100 / totalSize).toFixed(2) + "%");
                //log("onUploadProgress:file:" + uploadInfo.file.name + ", fileSize:" + totalSize + ", percent:" + Math.ceil(uploadedSize * 100 / totalSize) + "%");
            },
            // STS临时账号会过期，过期时触发函数
            'onUploadTokenExpired': function () {
                log("onUploadTokenExpired");
                if (isVodMode()) {
                    // 实现时，从新获取UploadAuth
                    // uploader.resumeUploadWithAuth(uploadAuth);
                } else if (isSTSMode()) {
                    // 实现时，从新获取STS临时账号用于恢复上传
                    // uploader.resumeUploadWithToken(accessKeyId, accessKeySecret, secretToken, expireTime);
                }
            },
            // 开始上传
            'onUploadstarted': function (uploadInfo) {
                getPz(uploadInfo.file.name);
                if (isVodMode()) {
                    var uploadAuth = document.getElementById("uploadAuth").value;
                    var uploadAddress = document.getElementById("uploadAddress").value;
                    uploader.setUploadAuthAndAddress(uploadInfo, uploadAuth, uploadAddress);
                }
                log("onUploadStarted:" + uploadInfo.file.name + ", endpoint:" + uploadInfo.endpoint + ", bucket:" + uploadInfo.bucket + ", object:" + uploadInfo.object);
            }
        });
        var accessKeyId = document.getElementById("accessKeyId").value;
        var accessKeySecret = document.getElementById("accessKeySecret").value;
        var secretToken = document.getElementById("secretToken").value;
        var expireTime = document.getElementById("expireTime").value;

        if (isVodMode()) {
            // 点播上传。每次上传都是独立的鉴权，所以初始化时，不需要设置鉴权
            uploader.init();
        } else if (isSTSMode()) {
            // OSS直接上传:STS方式，安全但是较为复杂，建议生产环境下使用。
            // 临时账号过期时，在onUploadTokenExpired事件中，用resumeWithToken更新临时账号，上传会续传。
            uploader.init(accessKeyId, accessKeySecret, secretToken, expireTime);
        } else {
            // OSS直接上传:AK方式，简单但是不够安全，建议测试环境下使用。
            uploader.init(accessKeyId, accessKeySecret);
        }
    }
    document.getElementById("files")
        .addEventListener('change', function (event) {
            var endpoint = document.getElementById("endpoint").value;
            var bucket = document.getElementById("bucket").value;
            var objectPre = document.getElementById("objectPre").value;
            var userData;
            if (isVodMode()) {

                userData = '{"Vod":{"UserData":"{"IsShowWaterMark":"false","Priority":"7"}"}}';
            } else {

                userData = '{"Vod":{"Title":"this is title.我是标题","Description":"this is desc.我是描述","CateId":"19",\
                "Tags":"tag1,tag2,标签3","UserData":"user data"}}';
            }
            var str = "";
            for (var i = 0; i < event.target.files.length; i++) {

                str += "<div class=\"control-group\">" +
                    "<label class=\"control-label\" style='font-size: 14px'>" + event.target.files[i].name + "</label>" +
                    "<div class=\"controls\">" +
                    "<div class='progress'>" +
                    "<div class='progress-bar' name=\"processbar" + fileIndex + "\" id=\"processbar" + fileIndex + "\"  style=\"width:0%\">" +
                    "<span id=\"bar" + fileIndex + "\">0%</span>" +
                    "</div>" +
                    "</div>" +
                    "</div>" +
                    "</div>";
                fileIndex++;
                log("add file: " + event.target.files[i].name);
                //uploader.addFile(event.target.files[i], endpoint, bucket, objectPre + event.target.files[i].name, userData);
                if (isVodMode()) {
                    // 点播上传。每次上传都是独立的OSS object，所以添加文件时，不需要设置OSS的属性
                    uploader.addFile(event.target.files[i], null, null, null, userData);
                } else {
                    uploader.addFile(event.target.files[i], endpoint, bucket, objectPre + event.target.files[i].name, userData);
                }
            }
            $("#Progress_Bars").html(str);
        });

    function save(names) {
        $.ajax({
            //async: false,
            type: "post",
            url: SERVERROOTDATA + "api/teacher/site/course.ashx?action=saveCourseVideo",
            data: {
                ycToken:$(window).storager({key: 'ycToken'}).readStorage(),
                // allowListen: document.getElementById("allowListen").value,
                // auditState: document.getElementById("auditState").value,
                // auditTime: document.getElementById("auditTime").value,
                // auditorId: document.getElementById("auditorId").value,
                // code: '0',
                courseId: document.getElementById("courseId").value,
                courseVideoId: document.getElementById("courseVideoId").value,
                name: document.getElementById("coursename").value,
                note: '',
                // recommendListen: document.getElementById("recommendListen").value,
                tag: document.getElementById("courseVideoId").value >0 ? 'update':'add',
                videoId: document.getElementById("videoId").value,
                videoPath: names
            }, //提交表单，vistor.ashx?ID=XXX
            success: function (res) {
                var data = JSON.parse(res);
                if(data.code==200){
                    layer.msg('上传成功');
                }
            } //操作成功后的操作！msg是后台传过来的值
            , error: function (ex) {
                alert("error");
            }
        });
    }
    function getPz(name) {
        $.ajax({
            async:false,
            url: SERVERROOTDATA+"api/teacher/site/course.ashx?action=getVideoAttribute",
            type: "POST",
            data: {coverurl:$('#coverurl').val(),tags:$('#tags').val(),description:$('#description').val(),video:name,ycToken:$(window).storager({key: 'ycToken'}).readStorage()},
            // processData: false,  // 告诉jQuery不要去处理发送的数据
            // contentType: false,   // 告诉jQuery不要去设置Content-Type请求头
            success:function (res) {
                var data = JSON.parse(res);
                // console.log(data);
                if(data.code==200){
                    $('#uploadAddress').val(data.rows.UploadAddress);
                    $('#uploadAuth').val(data.rows.UploadAuth);
                    $('#videoId').val(data.rows.VideoId);
                }
            }
        });
    }
    var textarea = document.getElementById("textarea");
    function Progress_Bar(progress, bar, processbar) {
        $("#" + bar).html(progress + "%");
        $("#" + processbar).attr("style", "width:" + progress + "%");
    }
    function start() {
        uploader.startUpload();
    }
    function stop() {
        uploader.stopUpload();
    }
    function resumeWithToken() {
        log("resume upload with token.");
        var uploadAuth = document.getElementById("uploadAuth").value;

        var accessKeyId = document.getElementById("accessKeyId").value;
        var accessKeySecret = document.getElementById("accessKeySecret").value;
        var secretToken = document.getElementById("secretToken").value;
        var expireTime = document.getElementById("expireTime").value;

        if (isVodMode()) {
            uploader.resumeUploadWithAuth(uploadAuth);
        } else if (isSTSMode()) {
            uploader.resumeUploadWithToken(accessKeyId, accessKeySecret, secretToken, expireTime);
        }
    }
    function clearList() {
        fileIndex = 0;
        ProgressIndex = 0;
        $("#Progress_Bars").html("");

        log("clean upload list.");
        clearInputFile();

    }
    function getList() {
        log("get upload list.");
        var list = uploader.listFiles();
        for (var i = 0; i < list.length; i++) {
            log("file:" + list[i].file.name + ", status:" + list[i].state + ", endpoint:" + list[i].endpoint + ", bucket:" + list[i].bucket + ", object:" + list[i].object);
        }
    }
    function deleteFile() {
        if (document.getElementById("deleteIndex").value) {
            var index = parseInt(document.getElementById("deleteIndex").value) - 1;
            log("delete file");
            // log("delete file index:" + index);
            uploader.deleteFile(index);
        }
    }
    function cancelFile() {
        if (document.getElementById("cancelIndex").value) {
            var index = document.getElementById("cancelIndex").value
            log("cancel file index:" + index);
            uploader.cancelFile(index);
        }
    }
    function resumeFile() {
        if (document.getElementById("resumeIndex").value) {
            var index = document.getElementById("resumeIndex").value
            log("resume file index:" + index);
            uploader.resumeFile(index);
        }
    }

    function clearLog() {
        textarea.options.length = 0;
    }
    function log(value) {
        if (!value) {
            return;
        }

        var len = textarea.options.length;
        if (len > 0 && textarea.options[len - 1].value.substring(0, 40) == value.substring(0, 40)) {
            textarea.remove(len - 1);
        } else if (len > 25) {
            textarea.remove(0);
        }

        var option = document.createElement("option");
        option.value = value, option.innerHTML = value;
        textarea.appendChild(option);
    }
    function isVodMode() {
        var uploadAuth = document.getElementById("uploadAuth").value;
        // console.log(uploadAuth);
        return (uploadAuth && uploadAuth.length > 0);
    }

    function isSTSMode() {
        var secretToken = document.getElementById("secretToken").value;
        var expireTime = document.getElementById("expireTime").value;
        if (!isVodMode()) {
            if (secretToken && secretToken.length > 0 && expireTime && expireTime.length > 0) {
                return true;
            }
        }
        return false;
    }
    function clearInputFile()
    {
        var ie = (navigator.appVersion.indexOf("MSIE")!=-1);
        if( ie ){
            var file = document.getElementById("files");
            var file2= file.cloneNode(false);
            file2.addEventListener('change', selectFile);
            file.parentNode.replaceChild(file2,file);
        }
        else
        {
            document.getElementById("files").value = '';
        }
    }
</script>
</body>
</html>