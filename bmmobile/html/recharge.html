<!DOCTYPE html>
<html>

	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
		<meta http-equiv="Cache-Control" content="no-siteapp" />
		<meta name="renderer" content="webkit">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
		<meta name="format-detection" content="telephone=
			yes">
		<meta name="full-screen" content="yes">
		<meta name="x5-fullscreen" content="true">
		<meta name="keywords" content="播米在线">
		<meta name="description" content="播米在线">
		<link rel="apple-touch-icon-precomposed" href="/apple-touch-icon-57x57-precomposed.png" />
		<link rel="apple-touch-icon-precomposed" sizes="72x72" href="/apple-touch-icon-72x72-precomposed.png" />
		<link rel="stylesheet" href="../css/bmmobile.css" />
		<title>充值中心</title>

		<style>
			body {
				background-color: #f2f2f2;
				padding-top: 9rem;
			}
			
			#header {
				color: #fff;
				border-bottom: none;
				background-color: #1473e6;
			}
			
			header.blue span:first-child {
				background: url(../images/public/goBack2.png) no-repeat center;
				background-position: 0 center;
				background-size: 1.285rem 2.285rem;
			}
			
			#balanceBox {
				padding-top: 0.5rem;
				text-align: center;
				color: #fff;
				background-color: #1473e6;
			}
			
			#balanceBox .title {
				font-size: 2.14rem;
			}
			
			#balanceBox img {
				width: 2.85rem;
				height: 3.57rem;
				vertical-align: sub;
				margin-right: 1rem;
			}
			
			#balanceDetail {
				padding: 1.42rem 0 3rem;
			}
			
			#balance {
				font-size: 4.28rem;
			}
			
			#rechargeBox {
				padding: 0 2.14rem;
			}
			
			#rechargeBox .title {
				line-height: 4.57rem;
				color: #3b3b3b;
				font-size: 1.85rem;
			}
			
			#RechargeSelect {
				margin-left: -1.7rem;
			}
			
			.span4 {
				width: 33.33%;
				float: left;
			}
			
			#RechargeSelect .box {
				padding: 1.14rem .3rem 1.42rem;
				margin-left: 1.7rem;
				margin-bottom: 1.7rem;
				border-radius: 1rem;
				text-align: center;
				background-color: #fff;
			}
			
			#RechargeSelect .box.selected {
				box-shadow: 0 0 0 1px #1473e6;
			}
			
			.box .bomiMoney {
				color: #3b3b3b;
				font-size: 3.14rem;
			}
			
			.box img {
				width: 2.85rem;
				height: 3.57rem;
				vertical-align: sub;
				margin-left: .5rem;
			}
			
			.box .money {
				margin-top: 0.7rem;
				font-size: 1.857rem;
				color: #888;
			}
			
			#otherMoneryCount {
				display: block;
				width: 100%;
				line-height: 5.7rem;
				font-size: 2.42rem;
				text-align: center;
				border-radius: .6rem;
				color: #3b3b3b;
				background-color: #fff;
			}
			
			#showPayMoney {
				margin: 1.6rem 0;
			}
			
			#showPayMoney span {
				padding: 0 0.5rem;
				color: #1473e6;
			}
			
			#payType {
				padding: 3rem;
				border-radius: .6rem;
				background-color: #fff;
			}
			
			#payType label {
				position: relative;
				margin-right: 2.14rem;
				display: inline-block;
				vertical-align: middle;
			}
			
			#payType label i {
				position: absolute;
				display: inline-block;
				width: 2.28rem;
				height: 2.28rem;
				top: 0.4rem;
				left: 0.28rem;
				background: url(../images/public/agree1.png) no-repeat center;
				background-size: contain;
			}
			
			#payType label input:checked+i {
				background-image: url(../images/public/agree.png);
			}
			
			#payType input {
				width: 15rem;
				height: 3rem;
				opacity: 0;
			}
			
			.alipay {
				margin-bottom: 2.42rem;
			}
			
			.alipay span {
				display: inline-block;
				width: 10rem;
				margin-left: -12rem;
				vertical-align: middle;
			}
			
			.weixinpay span {
				display: inline-block;
				width: 17.85rem;
				margin-left: -12rem;
				vertical-align: middle;
			}
			#payBox {
				display: none;
				width: 100%;
				height: 100vh;
				border: none;
			}
			
			#surePay {
				display: block;
				margin: 2.14rem 0;
				font-size: 2.14rem;
				line-height: 5.7rem;
				border-radius: .6rem;
				color: #fff;
				text-align: center;
				background-color: #1473e6;
			}
		</style>
	</head>

	<body>
		<div class="bmmain-container">
			<header id="header" class="blue"><!--<span onclick="goBack()">返回</span>-->
				<p>充值中心</p><span>交易记录</span></header>
			<div id="balanceBox">
				<p class="title">播米币余额</p>
				<div id="balanceDetail"><img src="../images/public/balanceIcon.png" /><span id="balance">8.0</span></div>
			</div>
			<div id="rechargeBox">
				<p class="title">选择充值金额</p>
				<div id="RechargeSelect">
					<div class="span4">
						<div class="box selected" data-money="1.00"><span class="bomiMoney">1</span><img src="../images/public/balanceIcon.png" alt="">
							<p class="money">￥1.00</p>
						</div>
					</div>
					<div class="span4">
						<div class="box" data-money="6.00" ><span class="bomiMoney">6</span><img src="../images/public/balanceIcon.png" alt="">
							<p class="money">￥6.00</p>
						</div>
					</div>
					<div class="span4">
						<div class="box" data-money="10.0" ><span class="bomiMoney">10</span><img src="../images/public/balanceIcon.png" alt="">
							<p class="money">￥10.00</p>
						</div>
					</div>
					<div class="span4">
						<div class="box" data-money="20.00" ><span class="bomiMoney">20</span><img src="../images/public/balanceIcon.png" alt="">
							<p class="money">￥20.00</p>
						</div>
					</div>
					<div class="span4">
						<div class="box" data-money="66.00" ><span class="bomiMoney">66</span><img src="../images/public/balanceIcon.png" alt="">
							<p class="money">￥66.00</p>
						</div>
					</div>
					<div class="span4">
						<div class="box" data-money="99.00" ><span class="bomiMoney">99</span><img src="../images/public/balanceIcon.png" alt="">
							<p class="money">￥99.00</p>
						</div>
					</div>
				</div><input id="otherMoneryCount" type="number" placeholder="请输入金额" />
				<p id="showPayMoney" class="title">支付金额:<span>88 </span>元</p>
				<div id="payType">
					<!--<div class="alipay"><label onclick="changeChargeType()"><input type="radio" name="payType" checked="checked" value="0"/><i></i></label><span><img src="../images/public/aliPay.png" /></span></div>
					<div class="weixinpay"><label onclick="changeChargeType()"><input type="radio" name="payType" value="1" /><i></i></label><span><img src="../images/public/weixinPay.png" /></span></div>-->
				</div>
				<a id="surePay" href="#this">确认支付</a>
			</div>
		</div>
		<script type="text/javascript" src="../js/zepto.js"></script>
		<script type="text/javascript" src="../js/bmmain.js"></script>
		<script type="text/javascript" src="../js/layer.js"></script>
		<script type="text/javascript" src="../js/zepto.picLazyLoad.min.js"></script>
		<script>
			$(function() {
				var live = $.getUrlParam("live");//0是悦华，1是叠报
				if( live == 1){
					$(document).ready(function(e) {

					var counter = 0;
					if (window.history && window.history.pushState) {
					$(window).on('popstate', function () {
					window.history.pushState('forward', null, '#');
					window.history.forward(1);
					window.location.href='dbliveroom.html?live=1';//跳转到叠报直播
					});
					}
					window.history.pushState('forward', null, '#'); //在IE中必须得有这两行
					window.history.forward(1);
					});
				}else if( live == 0){
					$(document).ready(function(e) {

					var counter = 0;
					if (window.history && window.history.pushState) {
					$(window).on('popstate', function () {
					window.history.pushState('forward', null, '#');
					window.history.forward(1);
					window.location.href='liveroom.html?live=1';//跳转悦华直播
					});
					}
					window.history.pushState('forward', null, '#'); //在IE中必须得有这两行
					window.history.forward(1);
					});
				}
			
			
				var selectedMoney = 0,
					showPayMoney = $("#showPayMoney span"),
					otherMoneryCount = $('#otherMoneryCount'),
					rechargeType = 0,
					nameArr = [];
				var payType = "";

				selectedMoney = $(".selected").attr('data-money');
				showPayMoney.html(selectedMoney);
				otherMoneryCount.val(selectedMoney);

				inputOtherMonery(otherMoneryCount);

				changeSelected();
				payStyleShow();
				
				$("#surePay").on("click", function() {
						submitOrder(otherMoneryCount.val());
				});
				
				//change selected
				function changeSelected() {
					$('#RechargeSelect .box').click(function() {
						if($(this).hasClass("selected")) {
							return false;
						} else {
							$(this).parent().siblings().children('.selected').removeClass("selected");
							$(this).addClass("selected");
							selectedMoney = $(this).attr('data-money');
							console.log(selectedMoney)
							showPayMoney.html(selectedMoney);
							otherMoneryCount.val(selectedMoney);
						}

					});

				}

				//change rechargeType
				function changeChargeType() {
					nameArr = document.getElementsByName("payType");
					for(var i in nameArr) {
						if(nameArr[i].checked) {
							rechargeType = nameArr[i].value;
						}
					}
				}

				//input otherMonery
				function inputOtherMonery(obj) {
					$(obj).on("input", function() {
						showPayMoney.html(otherMoneryCount.val());
					}, false);

				}

				//submit charge
				function submitCharge() {
					$.ajax({
						type: "GET",
						url: SERVEROOTDATA + 'Member.ashx?action=updateConsigneeAddr',
						dataType: "json",
						data: {
							"mid": localStorage.getItem('$ycuid'),
							"moneyValue": 1,
							"rechargeType": rechargeType
						},
						success: function(result) {
							console.log(result)
						},
						error: function(err) {
							console.log(err);
						}
					});

				}
				
				function submitOrder(money) {//提交订单
					//var payType = $('input[name="payType"]:checked').val();
					
					var date = new Date();
					var month = date.getMonth() + 1;
					var strDate = date.getDate();
					var seconds = date.getSeconds();
					var randnum = "";
					for(var i = 0; i < 5; i++) {
						randnum += Math.floor(Math.random() * 10);
					}

					if(month >= 1 && month <= 9) {
						month = "0" + month;
					}
					if(strDate >= 0 && strDate <= 9) {
						strDate = "0" + strDate;
					}
					if(seconds >= 0 && seconds <= 9) {
						seconds = "0" + seconds;
					}

					var currentdate = String(date.getFullYear()) + String(month) + String(strDate) + String(date.getHours()) + String(date.getMinutes()) + String(seconds) + String(randnum);
					$.ajax({
						type: "post",
						url: SERVEROOTDATA + "MemberGrade.ashx?action=purchaseMemberGrade",
						dataType: 'text',
						data: {
							memberId: localStorage.getItem("$ycuid"),
							rechargeAmount: money,
							rechargeList: currentdate,
							payTypeId: payType, //0: 支付宝， 1：微信 2：播米币； 3:"web 支付宝"
						},
						success: function(res) {
							if(res == 814 || res == "814") {
								payError();
								return false;
							}
							
							if(payType == 0) {
								openAliPayRUTE(money, currentdate, localStorage.getItem("$ycuid"), 0, 0, 0, 0);
								//openAliPayRUTE(oldTotalPrice,orderId,localStorage.getItem("$ycuid"),17);
							} else if(payType == 1) { //微信支付
								var ss = money+'_'+currentdate;
								window.location.href='https://open.weixin.qq.com/connect/oauth2/authorize?appid=wx7de03be2cd376b04&redirect_uri=http://m.bomizx.net/html/weixinrechargeturnpay.html&response_type=code&scope=snsapi_userinfo&state='+ss+'#wechat_redirect';
							}

						},
						error: function() {
							payError();
						}
					});
					
					
				}
				
				function payError() {//支付失败
					layer.open({
						content: "支付失败！",
						skin: 'msg',
						time: 2 //2秒后自动关闭
					})
					setTimeout(function() {
						window.location.reload();
					}, 1500)
				}
				
				function payStyleShow() {
					if(isWeiXin()) { //如果是微信浏览器,微信支付为1，支付宝为0
						payType = 1;
						$('#payType').html("<div class='weixinpay'><label><input value='1' type='radio' name='payType' checked='checked'/><i></i></label><span><img src='../images/public/weixinPay.jpg' /></span></div>");
						/*$('#payType .alipay').css('display', 'none');
						$('#payType .weixinpay').css('display', 'block');*/
					} else {
						payType = 0;
						$('#payType').html("<div class='alipay'><label><input value='0' type='radio' name='payType' checked='checked'/><i></i></label><span><img src='../images/public/aliPay.jpg' /></span></div>");
						/*$('#payType .alipay').css('display', 'block');
						$('#payType .weixinpay').css('display', 'none');*/
					}
				}
				
				function openAliPayRUTE(price, orderId, mId, dc, couId, otId, ptId) {//打开支付宝
					//页面层
					layer.open({
						type: 1,
						content: '<iframe id="payBox" src="' + SERVEROOTDATA + 'MemberRecharge.ashx?action=memberRecharge&rechargeAmount=' + price + '&rechargeList=' + orderId + '&memberId=' + mId + '&payTypeId=3"></iframe>',
						anim: 'up',
						style: 'position:fixed; bottom:0; left:0; width: 100%; height: 100%; border:none;'
					});
					setTimeout(function() {
						$("#payBox").css("display", "block");
					}, 2000)

				}
				
				function isWeiXin() {//判断是否是微信登录
					var ua = window.navigator.userAgent.toLowerCase();
					if(ua.match(/MicroMessenger/i) == 'micromessenger') {
						return true;
					} else {
						return false;
					}
				}
			});
		</script>
	</body>

</html>