<!DOCTYPE html>
<html>

	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
		<meta http-equiv="Cache-Control" content="no-siteapp" />
		<meta name="renderer" content="webkit">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
		<!--<meta name="format-detection" content="telephone=
			yes">
		<meta name="full-screen" content="yes">
		<meta name="x5-fullscreen" content="true">-->
		<meta name="keywords" content="播米在线">
		<meta name="description" content="播米在线">
		<link rel="apple-touch-icon-precomposed" href="/apple-touch-icon-57x57-precomposed.png" />
		<link rel="apple-touch-icon-precomposed" sizes="72x72" href="/apple-touch-icon-72x72-precomposed.png" />
		<!--<link rel="stylesheet" href="../css/bmmobile.css" />-->
		<link rel="stylesheet" href="../css/bm.css">
		<link rel="stylesheet" href="../css/bmmobile_cyq.css">
		<link rel="stylesheet" href="../css/dropload.css">
		<title>课程详情</title>

		<style>
			
			.swiper-container-horizontal>.swiper-pagination-bullets,
			.swiper-pagination-custom,
			.swiper-pagination-fraction {
				bottom: 10px;
				left: 0;
				width: 100%;
				overflow: hidden;
				padding-bottom: 2.5rem;
				border-bottom: 1px solid #eee;
			}
			
			.swiper-pagination-bullet {
				position: relative;
				box-sizing: border-box;
				width: 30%;
				float: left;
				display: inline-block;
				text-align: center;
				color: #282828;
				font-size: 1.635rem;
				background: none;
			}
			
			.swiper-pagination-bullet-active {
				opacity: 1;
				color: #1473e6;
			}
			
			.swiper-pagination-bullet-active:after {
				content: "";
				position: absolute;
				width: 80%;
				height: 1px;
				bottom: -2.52rem;
				left: 0;
				right: 0;
				width: 80%;
				margin: auto;
				background-color: #1473e6;
			}
			

			.courseHeader {
				padding: 0 0 1.6rem;
				border-bottom: 1px solid #eee;
			}
			
			#main {
				padding-top: 8rem;
			}
			
			#courseImg img {
				width: 100%;
				border-radius: .6rem;
			}
			
			#titleBar {
				padding: 1.71rem 2rem;
			}
			
			#titleBar .title {
				display: block;
				margin-right: 3.5rem;
				overflow: hidden;
				text-overflow: ellipsis;
				white-space: nowrap;
				color: #282828;
				font-size: 1.76rem;
			}
			
			#benefit {
				color: #d0d0d0;
				font-size: 1.24rem;
			}
			
			#priceBox {
				position: relative;
				padding: 0 2rem;
			}
			
			#currentPrice {
				color: #ff6633;
				font-size: 1.76rem;
			}
			
			#oldPrice {
				line-height: 1.5;
				color: #d0d0d0;
				font-size: 1.56rem;
				text-decoration: line-through;
			}
			
			#benefit {
				position: absolute;
				top: 1.5rem;
				left: 12rem;
			}
			
			#share {
				position: absolute;
				top: 0;
				right: 2rem;
				width: 4.3rem;
				height: 4.3rem;
				background: url(../images/public/shareIcon.png) no-repeat center;
				background-size: contain;
			}
			
			.coursepanel {
				padding-top: 0.9rem;
				padding-bottom: 5rem;
			}
			
			.coursepanel .swiper-wrapper {
				/*	box-sizing: border-box;*/
			}
			
			.detailBox {
				padding: 0.6rem 1.5rem;
			}
			
			.courseTitle {
				margin: 0.81rem 0;
				height: 3.54rem;
				font-size: 1.76rem;
				text-indent: 3rem;
				padding-top: 0.5rem;
				box-sizing: border-box;
				color: #1473e6;
				background: url(../images/public/titleIcon.png) no-repeat;
				background-size: contain;
			}
			
			.detail {
				line-height: 1.4;
				font-size: 1.35rem;
				color: #282828;
			}
			
			#outlineBox {
				padding: 1rem 2.14rem 0;
				font-size: 1.56rem;
				color: #282828;
			}
			
			#outlineBox li {
				position: relative;
				margin: 1.5rem 0;
				padding: 1rem 0;
				border-radius: 1rem;
				background-color: #f2f2f2;
			}
			
			#outlineBox li>a {
				display: block;
				color: #fff;
			}
			
			#outlineBox li span {
				vertical-align: middle;
			}
			
			#outlineBox li span:first-child {
				display: inline-block;
				padding: 0 1rem;
				min-width: 6.5rem;
				box-sizing: border-box;
			}
			
			#outlineBox li span:nth-child(2) {
				display: inline-block;
				width: calc(100% - 12rem);
				overflow: hidden;
				text-overflow: ellipsis;
				white-space: nowrap;
			}
			
			#outlineBox li.allowed {
				color: #fff;
				background-color: #2e85ef;
			}
			
			#outlineBox li.allowed i {
				position: absolute;
				right: 1.5rem;
				top: 1rem;
				display: inline-block;
				width: 2.2rem;
				height: 2.2rem;
				background: url(../images/public/playIcon.png) no-repeat center;
				background-size: contain;
			}
			
			#commentBox {
				padding: 1.8rem 2.14rem 0;
				color: #282828;
				font-size: 1.04rem;
			}
			
			#commentBox li {
				margin-bottom: 1rem;
			}
			
			#commentBox .top * {
				vertical-align: middle;
			}
			
			#commentBox .top img {
				margin-right: 1rem;
				width: 3.92rem;
				height: 3.92rem;
				border-radius: 50%;
			}
			
			#commentBox .top .time {
				float: right;
				margin-top: 1rem;
			}
			
			#commentBox .content {
				font-size: 1.142rem;
				line-height: 3;
			}
			
			#footernav {
				/*position: relative;*/
				position: fixed;
				z-index: 99;
				bottom: 0;
				left: 0;
				height: 4.5rem;
				width: 100%;
				box-sizing: border-box;
			}
			
			#footernav a {
				position: relative;
				float: left;
				display: inline-block;
				line-height: 4.5rem;
				width: 50%;
				/*width: 100%;*/
				font-size: 1.662rem;
				color: #282828;
				text-align: center;
				background-color: #fff;
				border-top: 1px solid #eee;
			}
			
			#footernav a:last-child {
				border-top: 1px solid #1473e6;
			}
			
			#footernav a:first-child:after {
				content: "";
				position: absolute;
				width: 1px;
				height: 100%;
				top: 0;
				right: 0;
				background-color: #eee;
			}
			
			#footernav a:last-child.checked {
				color: #fff;
				background-color: #1473e6;
			}
		</style>
	</head>

	<body>
		<div class="bmmain-container flex-wrap flex-vertical">
			<header class="blue flex-con">
				<span onclick="goBack()" style="display: none;">返回</span>
				<p>课程详情</p>
			</header>
			<div id="main" class="flex-con">
				<div class="courseHeader" id="courseHeader">
					<div id="courseImg"></div>
					<p id="titleBar"></p>
					<div id="priceBox"></div>
				</div>

				<div class="coursepanel">
					<div class="swiper-container course-container">
						<ul class="course-swiper-pagination flex-con" id="courseNav"></ul>
						<div class="swiper-wrapper swiper-no-swiping">
							<div class="swiper-slide">
								<div class="detailBox">
									<div class="courseTitle">学习目标</div>
									<div class="detail" id="targetBox"></div>
								</div>

								<div class="detailBox">
									<div class="courseTitle">适合对象</div>
									<div class="detail" id="fitBox"></div>
								</div>

								<div class="detailBox">
									<div class="courseTitle">核心知识点</div>
									<div class="detail" id="coreBox">
										<!--
									<p>1、了解股市基本知识</p>
									<p>2、了解公司在股票市场中的影响</p>
									<p>3、股票的除权除息</p>
									<p>4、各类股票的区别</p>
									<p>5、期货的基础知识和区别</p>
									<p>6、五大理论讲解</p>-->
									</div>
								</div>

								<div class="detailBox">
									<div class="courseTitle">老师介绍</div>
									<div class="detail" id="teacherBox">
										<!-- <p>特约高级分析师：陈翔（擅长解股 期、现货中长线布局 及短线快速狙击）。从事金融操盘和分析工作近十年，擅长中短线策略制定，合理把握资金管理和风险控制。深入研究波浪理论，黄金分割和平滑移动平均线(MACD)的结合应用，总结奇胜的交易模型《奇门战法》。 </p> -->
									</div>
								</div>
							</div>
							<div class="swiper-slide">
								<ul id="outlineBox"></ul>
							</div>
							<div class="swiper-slide">
								<section class="flex-con overAuto">
									<div id="content">
										<ul id="commentBox" class="clearfix"></ul>
									</div>
								</section>
							</div>
						</div>
					</div>
				</div>
			</div>
			<footer id="footernav">
				<a id="jfreelisten">免费试听</a>
				<a id="buy" class="checked" href="#this">立即购买</a>
			</footer>
		</div>

		<script type="text/javascript" src="../js/zepto.min.js"></script>
		<script type="text/javascript" src="../js/swiper.jquery.min.js"></script>
		<script type="text/javascript" src="../js/bmmain.js"></script>
		<script type="text/javascript" src="../js/layer.js"></script>
		<script type="text/javascript" src="../js/dropload.min.js"></script>

		<script>
			$(function() {
				var cId = $.getUrlParam("courseId");
				var outlineFlag = true;	//outline
				var freeListn = ""; //免费试听
				//评论

				var itemIndex = 0,
					LoadEnd_tab = false,
					pageCount = 0;

				// 每页展示6个
				var num = 6;
				var nownum = 0; //当前数据在第几条

				courseHeader(cId);
				//outline(cId); //获取大纲

				// dropload，获取评论
				var dropload = $('#content').dropload({
					scrollArea: window,
					loadUpFn:function(me){
						me.resetload();
					},
					loadDownFn: function(me) {
						//获取类型
						setTimeout(function() {
							pageCount++;
							comment(me, pageCount, cId, itemIndex); //默认首页
						}, 200);

					}
				});

				ckdetail(); //切换

				$('#jfreelisten').click(function() {
					console.log(freeListn)
					location.href = freeListn;
				})

				function courseHeader(id) { //获取类型
					var box = $('#courseHeader'),
						courseImg = $('#courseImg'),
						titleBar = $('#titleBar'),
						priceBox = $('#priceBox'),
						targetBox = $('#targetBox'), //学习目标
						fitBox = $('#fitBox'), //适用目标
						teacherBox = $('#teacherBox'), //老师介绍
						imgStr = "",
						htmlStr = "";
					$.ajax({
						type: "GET",
						url: SERVEROOTDATA + 'Course.ashx?action=getCourseDetailById',
						dataType: "json",
						data: {
							"courseId": id
						},
						success: function(result) {
							if(result[1].length < 1) {
								return false;
							}
							imgStr = "<img src='" + SERVEROOTFILE + result[1][0].mobileIconPath + "'/>";
							htmlStr = "<p id='currentPrice'>￥" + result[1][0].preferentialPrice + "</p><p id='oldPrice'>￥" + result[1][0].price + "</p><span id='benefit'>限时优惠，报班送开学大礼</span><span id='share'></span>";
							courseImg.html(imgStr);
							titleBar.html('<span class="title">' + result[1][0].name + '</span>');
							priceBox.html(htmlStr);
							targetBox.html('<p>' + result[1][0].studyAim + '</p>');
							fitBox.html('<p>' + result[1][0].fitObject + '</p>');
							window.kcxqSwiper.update();

						},
						error: function(err) {
							console.log(err);
						}
					});

					$.ajax({
						type: "GET",
						url: SERVEROOTDATA + 'Teacher.ashx?action=getTeacherByCourseId',
						dataType: "json",
						data: {
							"courseId": id
						},
						success: function(result) {
							if(result.length < 1) {
								console.log('没有课程详情数据')
								return false;
							}
							teacherBox.html('<p>' + result[0].name + result[0].note + '</p>');
							window.kcxqSwiper.update();
						},
						error: function(err) {
							console.log(err);
						}
					});

				}

				function ckdetail() {
					window.kcxqSwiper = new Swiper('.course-container', {
						mousewheelControl: false,
						noSwiping: true,
						autoHeight: true,
						pagination: '.course-swiper-pagination',
						paginationClickable: true,
						paginationBulletRender: function(tzksSwiper, index, className) {
							switch(index) {
								case 0:
									name = '课程详情';
									break;
								case 1:
									name = '课程大纲';
									break;
								case 2:
									name = '课程评价';
									break;
								default:
									name = '';
							}
							return '<li class="' + className + '" data-id=' + index + '>' + name + '</li>';
						}
					})
					//kcxqSwiper = kcxqSwiper;
					$('.course-container').on('click','.swiper-pagination-bullet',function(){
						var nowindex = $(this).attr('data-id');
						if(nowindex == 1){
							if(outlineFlag) {
								outline(cId); //获取大纲
							}
						}
					});

				}

				

				function outline(id) {
					var outlineBox = $('#outlineBox'), //课程列表
						$htmlStr = "";
					$.ajax({
						type: "GET",
						url: SERVEROOTDATA + 'CourseCatalog.ashx?action=getCourseCatalogByCourseId',
						dataType: "json",
						data: {
							"courseId": id
						},
						success: function(result) {
							if((result[1].length < 1) || (result[0].length < 1)) {
								return false;
							} else {
								if(result[0].isSold == '1') {
									freeListn = 'detailPlayer.html?courseCatalogId=' + result[1][0].courseCatalogId + "&videoId=" + result[1][0].videoId + "&courseId=" + result[1][0].courseId;
									result[1].forEach(function(value, index) {
										$htmlStr += "<li class='allowed'><a href='detailPlayer.html?courseCatalogId=" + value.courseCatalogId + "&videoId=" + value.videoId + "&courseId=" + value.courseId + "'><span>第" + (index + 1) + "节</span><span>" + value.name + "</span><i></i></a></li>";
									});
								} else {
									result[1].forEach(function(value, index) {
										if(value.allowListen == '1') {
											freeListn = 'detailPlayer.html?courseCatalogId=' + value.courseCatalogId + "&videoId=" + value.videoId + "&courseId=" + value.courseId;
											$htmlStr += "<li class='allowed'><a href='detailPlayer.html?courseCatalogId=" + value.courseCatalogId + "&videoId=" + value.videoId + "&courseId=" + value.courseId + "'><span>第" + (index + 1) + "节</span><span>" + value.name + "</span><i></i></a></li>";
										} else {
											$htmlStr += "<li class='noallowed'><span>第" + (index + 1) + "节</span><span>" + value.name + "</span><i></i></li>";
										}

									});
								}

								outlineBox.html($htmlStr);
								//ckdetail();
								window.kcxqSwiper.update();

								outlineFlag = false;
							}

						},
						error: function(err) {
							console.log(err);
						}
					});
				}

				function comment(me, pageIndex, id, numIndex) {
					var commentBox = $('#commentBox'), //评论部分
						htmlStr = "";
					$.ajax({
						type: "GET",
						url: SERVEROOTDATA + 'CourseEvaluation.ashx?action=getEvaluation',
						dataType: "json",
						data: {
							"courseId": id,
							"pageIndex": pageIndex,
							"pageSize": num
						},
						success: function(result) {
							var obj = result.rows;
							if(obj.length < 1) {
								LoadEnd_tab = true;
								// 锁定
								me.lock();
								// 无数据
								me.noData();

								// 为了测试，延迟1秒加载
								setTimeout(function() {
									// 每次数据加载完，必须重置
									me.resetload();
								}, 1000);

								return false;
							} else {
								obj.forEach(function(value, index) {
									var imgSrc = value.iconPath;
									if((imgSrc == "") || (imgSrc == undefined) || (imgSrc == "undefined")) {
										imgSrc = '../images/public/default.png';
									} else {
										imgSrc = SERVEROOTFILE + imgSrc;
									}

									htmlStr += "<li><div class='top'><img src='" + imgSrc + "' /><span class='name'>" + value.nickName + "</span><span class='time'>" + value.evaluationDate + "</span></div><div class='content'>" + value.evaluation + "</div></li>";
									nownum = (pageIndex- 1) * num + index + 1;
									if((nownum) >= result.totalCount) {
										console.log('到底啦')
										// 数据加载完
										//LoadEnd = true;
										LoadEnd_tab[numIndex] = true;
										// 锁定
										me.lock();
										// 无数据
										me.noData();
										//break;
									}
								});
								// 为了测试，延迟1秒加载
								setTimeout(function() {
									commentBox.append(htmlStr);
									// 每次数据加载完，必须重置
									window.kcxqSwiper.update();
									me.resetload();
								}, 1000);

							}

						},
						error: function(err) {
							console.log('服务器出错了~');
							// 加载出错，也得重置
							me.resetload();
						}
					});

				}
				openPlayTips();

				function openPlayTips() {
					$('.noallowed').click(function() {
						layer.open({
							content: '非试听课程暂不支持点播,请先购买!',
							skin: 'msg',
							time: 2 //2秒后自动关闭
						});

					})

				}

				getOrderId();
				//get orderId
				function getOrderId() {
					$('#buy').click(function() {
						if(!isLogined()) {
							layer.open({
								content: '非会员用户无法购物哦！',
								btn: ['登录', '取消'],
								yes: function(index) {
									//location.reload();
									window.location.href = ROOT + "login.html"
									layer.close(index);
								}
							});
						} else {
							getOrderIddata(cId);

						}
					});
				}
				//获取订单数据
				function getOrderIddata(id) {
					$.ajax({
						type: "GET",
						url: SERVEROOTDATA + 'Order.ashx?action=directBuyGoods',
						dataType: "json",
						data: {
							"memberId": localStorage.getItem("$ycuid"),
							"goodsId": id
						},
						success: function(result) {
							var obj = result[0];
							if(obj) {
								window.location.href = 'pay.html?orderId=' + obj.orderId;

							}
							if(result == 818 || result == "818") {
								layer.open({
									content: "您已购买过该课程！",
									skin: 'msg',
									time: 2 //2秒后自动关闭
								});
							}

						},
						error: function(err) {
							if(err.body == 818 || err.body == "818") {
								layer.open({
									content: "您已购买过该课程！",
									skin: 'msg',
									time: 2 //2秒后自动关闭
								});
							}
						}
					});
				}

			});
		</script>
	</body>

</html>