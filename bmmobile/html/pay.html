<!DOCTYPE html>
<html>

	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
		<meta http-equiv="Cache-Control" content="no-siteapp" />
		<meta name="renderer" content="webkit">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
		<!--<meta name="format-detection" content="telephone=
			yes">
		<meta name="full-screen" content="yes">
		<meta name="x5-fullscreen" content="true">-->
		<meta name="keywords" content="播米在线">
		<meta name="description" content="播米在线">
		<link rel="apple-touch-icon-precomposed" href="/apple-touch-icon-57x57-precomposed.png" />
		<link rel="apple-touch-icon-precomposed" sizes="72x72" href="/apple-touch-icon-72x72-precomposed.png" />
		<!--<link rel="stylesheet" href="../css/bmmobile.css" />-->
		<link rel="stylesheet" href="../css/bm.css">
		<link rel="stylesheet" href="../css/bmmobile_cyq.css">
		<title>订单详情</title>

		<style>
			body {
				background-color: #f2f2f2;
				padding-top: 8rem;
			}
			
			#orderBox li {
				position: relative;
				padding: 1.14rem 1.14rem 1.71rem;
				/*border-bottom: 0.3rem solid #f2f2f2;*/
				border-bottom: 1px solid #f2f2f2;
				overflow: hidden;
				background-color: #fff;
			}
			
			#orderBox li img {
				max-height: 400px;
				min-height: 300px;
				overflow: hidden;
				margin-bottom: 1rem;
				border-radius: 0.6rem;
				width:100%;
			}
			
			#orderBox .title {
				/*padding-left: 21.4rem;*/
				margin-bottom: 1rem;
				font-size: 1.662rem;
				color: #282828;
			}
			
			#orderBox .brief {
				margin: 1rem 0 1.3rem;
				/*padding-left: 21.4rem;*/
				font-size: 1.351rem;
				color: #b1b1b1;
			}
			
			#orderBox .expire {
				display: none;
				/*padding-left: 21.4rem;*/
				font-size: 0.727rem;
				color: #282828;
			}
			
			#orderBox .price {
				/*position: absolute;*/
				/*top: 1.14rem;
            right: 2.14rem;*/
				/*margin: 1rem 0;*/
				font-size: 2.14rem;
				color: #ff0000;
			}
			
			.tips {
				line-height: 4.72rem;
				border-bottom: 1px solid #f2f2f2;
				/*padding-left: 2.14rem;*/
				/*border-top: 2.85rem solid #f2f2f2;
            border-bottom: 2.85rem solid #f2f2f2;*/
				padding: 0 3rem;
				text-align: right;
				font-size: 1.556rem;
				color: #282828;
				background-color: #fff;
			}
			
			#payType {
				margin: 1.2rem 0;
				padding: 1.8rem;
				background-color: #fff;
			}
			
			#payType label {
				position: relative;
				margin-right: 1.5rem;
				display: inline-block;
				vertical-align: middle;
			}
			
			#payType label i {
				position: absolute;
				display: inline-block;
				width: 2.28rem;
				height: 2.28rem;
				top: 0.4rem;
				left: 0.28rem;
				background: url(../images/public/agree1.png) no-repeat center;
				background-size: contain;
			}
			
			#payType label input:checked+i {
				background-image: url(../images/public/agree.png);
			}
			
			#payType input {
				width: 13rem;
				height: 3rem;
				opacity: 0;
			}
			
			.alipay {
				margin-bottom: 2.42rem;
			}
			
			.alipay span {
				display: inline-block;
				width: 10rem;
				margin-left: -10rem;
				vertical-align: middle;
			}
			
			.weixinpay span {
				display: inline-block;
				width: 10rem;
				margin-left: -10rem;
				vertical-align: middle;
			}
			
			#submitPay {
				display: block;
				margin: 2rem 2.14rem 1rem;
				line-height: 4.24rem;
				border-radius: .6rem;
				text-align: center;
				font-size: 1.76rem;
				color: #fff;
				background-color: #1473e6;
			}
			
			.couponWrap {
				overflow: hidden;
				background-color: #fff;
			}
			
			.couponTitle {
				position: relative;
				padding: 1.13rem 1.13rem 0;
				font-size: 1.63rem;
			}
			
			#couponbox {
				padding: 1.63rem 1.63rem 0;
			}
			
			.show #couponbox li {
				display: block;
			}
			
			#couponbox li {
				display: none;
				margin-bottom: 2.14rem;
				border-radius: 1rem;
				font-size: 1.5rem;
				color: #fff;
				background-color: #f2f2f2;
			}
			
			#couponbox li.selected {
				box-shadow: 0 0 0 1px #f00;
			}
			
			#couponbox .top {
				border-top-left-radius: 1rem;
				border-top-right-radius: 1rem;
				padding: 1rem 1.63rem;
				background: #f59b10;
			}
			
			#couponbox .moneyType {
				margin-left: 1.63rem;
				font-size: 1.63rem;
			}
			
			#couponbox .moneyNumber {
				float: right;
				margin-top: .4rem;
				font-size: 2.8rem;
			}
			
			#couponbox .moneyNumber i {
				font-size: 2.284rem;
				font-style: normal;
				vertical-align: text-top;
			}
			
			#couponbox .bottom {
				padding: 0.6rem 1.2rem;
				color: #636363;
			}
			
			#couponbox img {
				width: 4rem;
				height: 4rem;
				vertical-align: middle;
			}
			
			#couponbox .icon {
				display: inline-block;
				width: 1.58rem;
				height: 1.58rem;
				vertical-align: middle;
				background: url(../images/public/timeIcon.png) no-repeat center;
				background-size: cover;
				margin-bottom: 0.1rem;
			}
			
			#couponbox .time {
				margin-left: 0.5rem;
			}
			
			#couponbox .useStatus {
				float: right;
			}
			
			#openCoupon {
				position: absolute;
				top: 1.5rem;
				right: 1.63rem;
				width: 1.63rem;
				height: 1.3rem;
				background: url(../images/public/openIcon.png) no-repeat center;
				background-size: cover;
				/*-webkit-transition:all .3s;
            transition:all .3s;*/
			}
			
			.show #openCoupon {
				-webkit-transform: rotate(180deg);
				transform: rotate(180deg);
			}
			
			#payBox {
				display: none;
				width: 100%;
				height: 100vh;
				border: none;
			}
			
			@media screen and (max-width: 760px) {
				#orderBox li img {
					max-height: 400px;
					min-height: 200px;
				}
			}
			
			@media screen and (max-width: 476px) {
				#orderBox li img {
					max-height: 300px;
					min-height: 100px;
				}
			}
		</style>
	</head>

	<body>
		<div class="bmmain-container">
			<header id="header" class="blue">
				<span onclick="goBack()" style="display: none;">返回</span>
				<p>付款方式</p>
				<span id="deleteOrder">取消</span>
			</header>
			<!--<p class="tips" id="tips">23:59</p>-->
			<ul id="orderBox"></ul>

			<div class="couponWrap">
				<h3 class="couponTitle">我的优惠券 <span id="openCoupon"></span></h3>
				<ul id="couponbox">
					<!-- <li style="background-color:#fff; font-size:2.14rem; text-align:center; color:#282828">
              <p class="notCouponTips">暂无优惠券</p>
            </li> -->
					<li data-id="10" data-price="16">
						<div class="top">
							<img src="../images/public/couponIcon.png" />
							<span class="moneyType">优惠金</span>
							<span class="moneyNumber">￥16</span>
						</div>
						<div class="bottom">
							<span class="icon"></span>
							<span class="time">2017.05.12-2017.09.22</span>
							<span class="useStatus">未使用</span>
						</div>
					</li>
					<li data-id="12" data-price="20">
						<div class="top">
							<img src="../images/public/couponIcon.png" />
							<span class="moneyType">优惠金</span>
							<span class="moneyNumber">￥20</span>
						</div>
						<div class="bottom">
							<span class="icon"></span>
							<span class="time">2017.05.12-2017.09.22</span>
							<span class="useStatus">未使用</span>
						</div>
					</li>
				</ul>
			</div>

			<div id="payType">
				<!--<div class="alipay" >
					<label>
          <input value="0" type="radio" name="payType" checked="checked"/>
          <i></i>
        </label>
					<span><img src="../images/public/aliPay.jpg" /></span>
				</div>
				<div class="weixinpay" >
					<label>
          <input value="1" type="radio" name="payType" checked="checked"/>
          <i></i>
        </label>
					<span><img src="../images/public/weixinPay.jpg" /></span>
				</div>-->
			</div>

			<a id="submitPay">确认支付: ￥<span id="totalPrice"></span></a>
		</div>
		<script type="text/javascript" src="../js/zepto.js"></script>
		<script type="text/javascript" src="../js/bmmain.js"></script>
		<script type="text/javascript" src="../js/layer.js"></script>
		<script type="text/javascript" src="../js/zepto.picLazyLoad.min.js"></script>
		<script>
			$(function() {

				var orderId = $.getUrlParam("orderId");
				var payType = "";
				var isClick = true;//是否可以点击支付
				
				//var orderTime = $(this).getUrlParam("orderTime");
				var selectedCouponId = "", //选中的优惠券ID
					selectedCouponPrice = 0, //选中优惠的金额
					oldTotalPrice = 0; //没有添加优惠券之前

				$('#deleteOrder').click(function() {
					deleteOrder(orderId);
				});

				orderListDetail(orderId);

				function deleteOrder(id) {
					$.ajax({
						type: "GET",
						url: SERVEROOTDATA + 'Order.ashx?action=deleteOrder',
						dataType: "json",
						data: {
							"memberId": localStorage.getItem('$ycuid'),
							"orderId": orderId,
							"orderType": '' //0-未完成，1-已完成
						},
						success: function(result) {
							layer.open({
								content: '订单取消成功!',
								skin: 'msg',
								time: 2 //2秒后自动关闭
							});
							setTimeout(function() {
								goBack();
							}, 2000);

						},
						error: function(err) {
							console.log(err);
						}
					});
				}

				//server del
				function delOrderServer(orderId) {
					//server del
					$.ajax({
						type: "GET",
						url: SERVEROOTDATA + 'Order.ashx?action=deleteOrder',
						dataType: "text",
						data: {
							"memberId": localStorage.getItem('$ycuid'),
							"orderId": orderId,
							"orderType": orderType
						},
						success: function() {
							checkArr = [];
							delStatus(0); //del status
						},
						error: function(err) {
							console.log(err)
						}
					});
				}

				selectedCoupon();
				//select coupon
				function selectedCoupon() {
					$('#couponbox li').click(function() {
						if($(this).hasClass("selected")) {
							$(this).toggleClass('selected');
						} else {
							$(this).siblings(".selected").removeClass('selected');
							$(this).toggleClass('selected');
						}
						refreshCouponInf();
					});

				}

				//refresh CouponInf
				function refreshCouponInf() {
					var selectedObj = $(".selected");
					if("null" == selectedObj || null == selectedObj) {
						selectedCouponId = "";
						selectedCouponPrice = 0;
					} else {
						selectedCouponId = selectedObj.attr('data-id');
						selectedCouponPrice = selectedObj.attr('data-price');
					}
					$("#totalPrice").html(oldTotalPrice - selectedCouponPrice);
				}

				toggleCoupon();
				//toggle coupon
				function toggleCoupon() {
					$('#openCoupon').click(function() {
						$(this.parentNode).toggleClass('show');
						$('.couponTitle').siblings().children('li').css('display', 'none');
						$('.show').siblings().children('li').css('display', 'block');
					})

				}

				//get orderDetail list
				function orderListDetail(orderId) {
					var orderBox = $('#orderBox'),
						$htmlStr = '';
					$.ajax({
						type: "GET",
						url: SERVEROOTDATA + 'OrderDetail.ashx?action=getOrderListByOrderId',
						dataType: "json",
						data: {
							"mid": localStorage.getItem('$ycuid'),
							"orderId": orderId
						},
						success: function(result) {
							var obj = result[0];

							if(obj) {
								oldTotalPrice = obj.preferentialTotalPrice;
								$("#totalPrice").html(oldTotalPrice);
								obj.list.forEach(function(value, index) {
									var imgSrc = value.mobileIconPath;
									if((imgSrc == "") || (imgSrc == undefined) || (imgSrc == "undefined")) {
										imgSrc = 'images/public/default.png';
									} else {
										imgSrc = SERVEROOTFILE + imgSrc;
									}
									$htmlStr = "<li><img class='lazyload' src='../images/public/default.png' data-original=" + imgSrc + " /><p class='title'>" + value.courseName + "</p><p class='brief'>" + value.note + "</p><span class='price'>￥" + value.preferentialPrice + "</span></li>";
								});
								orderBox.html($htmlStr);
								$("#orderBox .lazyload").picLazyLoad({
									threshold: 10
								});
							}
							//orderTimeDeal();
						},
						error: function(err) {
							console.log(err)
						}
					});
				}

				//order time deal
				function orderTimeDeal(orderTime) {
					var orderTimeTemp = orderTime.replace(/-/g, "/");
					var currentTime = Date.parse(new Date()),
						orderTime = Date.parse(new Date(orderTimeTemp));
					var diffTime = currentTime - orderTime,
						oneDayStamp = 24 * 60 * 60 * 1000,
						oneDayDiff = "",
						tempTimeMinute = "",
						tempTimeHour = "",
						tips = $('#tips');
					oneDayDiff = oneDayStamp - diffTime;
					if(oneDayDiff < 0) {
						tips.html('订单已过期,请重新下单！');
						clearInterval(refreshTime);
					} else {
						tempTimeMinute = Math.floor((oneDayDiff / 1000 / 60) % 60); // minute
						tempTimeHour = Math.floor((oneDayDiff / 1000 / 60 / 60)); // hour
						tips.html(tempTimeHour + ':' + tempTimeMinute);
					}
				}

				function payError() {
					layer.open({
						content: "支付失败！",
						skin: 'msg',
						time: 2 //2秒后自动关闭
					})
					setTimeout(function() {
						window.location.reload();
					}, 1500)
				}

				function payStyleShow() {
					if(isWeiXin()) { //如果是微信浏览器,微信支付为1，支付宝为0
						payType = 1;
						$('#payType').html("<div class='weixinpay'><label><input value='1' type='radio' name='payType' checked='checked'/><i></i></label><span><img src='../images/public/weixinPay.jpg' /></span></div>");
						/*$('#payType .alipay').css('display', 'none');
						$('#payType .weixinpay').css('display', 'block');*/
					} else {
						payType = 0;
						$('#payType').html("<div class='alipay'><label><input value='0' type='radio' name='payType' checked='checked'/><i></i></label><span><img src='../images/public/aliPay.jpg' /></span></div>");
						/*$('#payType .alipay').css('display', 'block');
						$('#payType .weixinpay').css('display', 'none');*/
					}
				}
				payStyleShow();

				function submitOrder() {
					
					//var payType = $('input[name="payType"]:checked').val();

					$.ajax({
						type: "post",
						url: SERVEROOTDATA + "Pay.ashx?action=directPay",
						dataType: 'text',
						data: {
							memberId: localStorage.getItem("$ycuid"),
							amount: oldTotalPrice,
							orderId: orderId,
							discount: 0,
							couponReceiveId: 0,
							payTypeId: payType, //0: 支付宝， 1：微信 2：播米币； 3:"web 支付宝"
							orderTypeId: 0,
						},
						success: function(res) {
							if(res == 814 || res == "814") {
								payError();
								return false;
							}

							if(payType == 0) {
								openAliPayRUTE(oldTotalPrice, orderId, localStorage.getItem("$ycuid"), 0, 0, 0, 0);
								//openAliPayRUTE(oldTotalPrice,orderId,localStorage.getItem("$ycuid"),17);
							} else if(payType == 1) { //微信支付
								var ss = oldTotalPrice+'_'+orderId+'_coursepay';
								window.location.href='https://open.weixin.qq.com/connect/oauth2/authorize?appid=wx7de03be2cd376b04&redirect_uri=http://m.bomizx.net/html/weixinturnpay.html&response_type=code&scope=snsapi_userinfo&state='+ss+'#wechat_redirect';
								/*setTimeout(function() {
									var json = eval('(' + res + ')');
									console.log(json.iconPath);
									layer.open({
										type: 1,
										content: "<div class='dycweixin-img' style='text-align:center;width:50%;height:50%;line-height:1;margin:20px auto 0'><img src=" + SERVEROOTFILE + json.iconPath + " /></div><p style='text-align:center;margin-top:2rem'>应付金额：<span style='color: #df5e3f;font-size: 2rem;'>￥" + oldTotalPrice + "</span></p><p style='text-align:center;line-height:3'>长按识别二维码</p>",
										anim: 'up',
										style: 'position:fixed; bottom:0; left:0; width: 100%; height: 50%; padding:10px 0; border:none;',
										success: function() {
											isClick = true;
											setTimeout(function() {//推迟半分钟检验

												var xunhuan = setInterval(function() {
													$.ajax({
														type: "post",
														url: SERVEROOTDATA + "Pay.ashx?action=checkPaySuccess",
														dataType: 'text',
														data: {
															memberId: localStorage.getItem("$ycuid"),
															orderId: orderId
														},
														success: function(ress) {
															if(ress == '812') {
																clearInterval(xunhuan);
																layer.closeAll();

																setTimeout(function() {
																	window.location.href = "lecturecourselist.html";
																}, 3000);

															} else {
																return false;
															}
															
															else if(ress == '814') {
																clearInterval(xunhuan);
																layer.open({
																	content: '未完成支付,继续完成支付？',
																	btn: ['取消', '支付'],
																	yes: function(index) {
																		layer.closeAll();
																	},
																	no:function(index){
																		location.reload();
																	}
																});
															} 
														}
													});
												}, 3000);

											}, 30000);
										}
									});
								}, 500);*/
							}

							//							window.open('turnpay.html?amount=' + oldTotalPrice + '&orderId=' + orderId + '&memberId=' + localStorage.getItem("$ycuid") + '&discount=' + 0 + '&couponReceiveId=' + 0 + '&orderTypeId=0');
						},
						error: function() {
							payError();
						}
					})
				}

				/*function openAliPayRUTE(rechargeAmount,rechargeList,uid,memberGradeId) {
					//页面层
					layer.open({
						type: 1,
						content: '<iframe id="payBox" src="'+SERVEROOTDATA+'MemberGrade.ashx?action=purchaseMemberGrade&purchaseAmount='+
						rechargeAmount+'&payTypeId=3&purchaseList='+
						rechargeList+'&memberId='+
						uid +'&memberGradeId='+
						memberGradeId+'"></iframe>',
						anim: 'up',
						style: 'position:fixed; bottom:0; left:0; width: 100%; height: 100%; border:none;'
					});
					
					setTimeout(function(){
						$("#payBox").css("display","block");
					},2000)
				}*/

				function openAliPayRUTE(price, orderId, mId, dc, couId, otId, ptId) {
					//页面层
					layer.open({
						type: 1,
						content: '<iframe id="payBox" src="' + SERVEROOTDATA + 'Pay.ashx?action=directPay&amount=' + price + '&orderId=' + orderId + '&memberId=' + mId + '&discount=' + dc + '&couponReceiveId=' + couId + '&orderTypeId=' + otId + '&payTypeId=3"></iframe>',
						anim: 'up',
						style: 'position:fixed; bottom:0; left:0; width: 100%; height: 100%; border:none;'
					});
					setTimeout(function() {
						$("#payBox").css("display", "block");
					}, 2000)

				}

				function isWeiXin() {
					var ua = window.navigator.userAgent.toLowerCase();
					if(ua.match(/MicroMessenger/i) == 'micromessenger') {
						return true;
					} else {
						return false;
					}
				}
				$("#submitPay").on("click", function() {
					if(isClick){//防止多次弹出提示框
						isClick = false;
						submitOrder();
					}
					
				})

			});
		</script>
	</body>

</html>